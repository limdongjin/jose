# Python JWT 재구현 계획

이 문서는 TypeScript 구현을 참고하여 Python으로 JWT 기능을 재구현하기 위한 단계별 계획과 작업 항목을 정의한다.

## 1) 요구사항 정리

- 지원 알고리즘: TS 구현에서 사용하는 JWA 알고리즘을 동일하게 지원한다.
- 토큰 구성요소: Header, Payload(Claims), Signature 처리.
- 검증 규칙: 만료/발급/유효기간/시계 오차 허용치 등 TS 규칙과 동일.
- 표준 클레임 검증: `iss`, `sub`, `aud`, `jti` 포함 규칙을 TS와 일치하도록 반영한다.
- 에러 모델: 에러 타입/메시지/분기 기준을 TS와 맞춘다.
- 키 처리: 대칭키/비대칭키/키 포맷(PEM/JWK 등) 지원 범위를 정리한다.
- JWT 보호 헤더의 `crit`/`b64` 조합에 따른 JWT 허용/거부 규칙을 TS와 동일하게 적용한다.

## 2) API 설계

- 공개 API는 최소하고 명확하게 구성한다.
  - `encode(payload, key, alg, headers=None, options=None)`
  - `decode(token, key, algorithms=None, options=None)`
  - `verify(token, key, algorithms=None, options=None)`
- `options`에는 시간 관련(현재 시간 오버라이드, 허용 오차), 클레임 강제 검증 여부, 키 선택 전략 등을 포함한다.
- 예외 클래스는 `errors.py`에 정의하고, 사용자가 특정 예외를 잡아낼 수 있도록 분류한다.

## 3) 모듈별 구현 계획

### 3.1 algorithms.py

- JWA 알고리즘 구현 및 서명/검증 인터페이스 정의.
- 해시/HMAC/RSA/ECDSA 등 TS 구현에서 사용하는 알고리즘을 순차적으로 지원.
- 알고리즘 레지스트리를 제공해 문자열 → 구현체 매핑.
- **진행 상황:** HS256 HMAC 구현 및 레지스트리 초기화 완료.
  - HS384/HS512 HMAC 구현 추가.

### 3.2 keys.py

- 키 로딩/파싱 유틸 제공.
- PEM/JWK 입력 지원.
- 공개키/개인키 사용 분기 및 타입 검증.
  - JWK `kty: "oct"`(대칭키) 입력 지원.

### 3.3 claims.py

- 표준 클레임(`iss`, `sub`, `aud`, `exp`, `nbf`, `iat`, `jti`) 검증 로직 구현.
- 타입 강제/형변환 규칙 정의.
- 시간 관련 옵션(허용 오차, 현재 시간 오버라이드) 처리.
- **진행 상황:** `exp`, `nbf`, `iat` 기본 검증과 시간 옵션 처리 완료.
  - `iss`, `sub`, `aud`, `jti` 검증 및 옵션 기반 필수 여부 처리 완료.
  - `typ` 헤더 검증 옵션 추가(미디어 타입 정규화 포함).
  - `max_token_age` 옵션과 사람이 읽을 수 있는 시간 문자열 파싱(`iat` 강제 포함) 추가.
  - `exp` 만료 경계 및 `max_token_age` 사용 시 `iat` 미래 허용치 검증을 TS 로직과 정렬.

### 3.4 token.py

- 토큰 인코딩/디코딩/검증 로직 통합.
- Base64URL 인코딩/디코딩 처리.
- 헤더/페이로드 JSON 직렬화 규칙 정의.
- **진행 상황:** `encode`, `decode`, `verify` 기본 구현 완료(HS256/HS384/HS512 기준).
  - `crit` 헤더 검증과 `b64` 확장 헤더 처리 추가.

### 3.5 errors.py

- 에러 계층 정의(InvalidTokenError, InvalidSignatureError 등).
- TS 구현의 에러 메시지/분류와 일치하도록 맞춤.
- **진행 상황:** 기본 에러 계층 구현 완료.

### 3.6 utils.py

- Base64URL, JSON 직렬화, 시간 유틸 등 공용 기능.
- **진행 상황:** Base64URL, JSON 직렬화 유틸 구현 완료.
  - 시간 문자열 파싱 유틸(`parse_timespan`) 추가.

## 4) 테스트 전략

- 단위 테스트: 알고리즘/클레임/키 처리 모듈별 테스트.
- 호환성 테스트: TS 구현이 생성한 토큰/에러 케이스를 Python에서 재현.
- 경계 조건: 만료, 미래 발급, 허용 오차 등 시간 관련 케이스.
- **진행 상황:** 기본 토큰/클레임 검증 단위 테스트 추가.
  - `iss`, `sub`, `aud`, `jti` 검증 케이스 추가.

## 5) 마이그레이션/호환성 체크리스트

- TS 코드의 공개 API와 1:1 대응되는 Python API 매핑 문서 작성.
- 각 알고리즘별 테스트 벡터 확보.
- 에러 메시지, 옵션 동작, 기본값 비교표 작성.

## 6) 단계별 일정(초안)

1. **설계 확정**: TS 코드 분석 및 API/옵션/에러 모델 확정
2. **핵심 유틸 구현**: Base64URL/JSON/시간 유틸
3. **알고리즘 구현**: HMAC → RSA → ECDSA 순으로 확장
4. **토큰 처리 구현**: encode/decode/verify 완성
5. **클레임 검증**: 표준 클레임 + 옵션 처리
6. **테스트 확장**: 단위 + 호환성 테스트
7. **문서화 정리**: README, 사용 예시, 호환성 표

## 7) 초기 작업 항목(바로 실행 가능)

- [ ] TS 구현에서 사용 중인 알고리즘/옵션 목록 추출
- [ ] TS 에러 타입 및 메시지 표 작성
- [x] Python 패키지 구조 확정 및 초기 스캐폴딩
- [ ] 테스트 벡터 정리(성공/실패 케이스)
- [x] 표준 클레임(`iss`, `sub`, `aud`, `jti`) 검증 옵션 확장

## 8) 다음 구현 단계(업데이트)

1. PEM/비대칭 JWK 키 파싱 로딩 유틸 추가
2. 공개키 알고리즘(RSA/ECDSA) 구현
3. 테스트 스캐폴딩 및 벡터 추가
